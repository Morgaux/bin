#!/bin/sh
# shellcheck disable=SC2068

#
# dmenu based dropdown terminal
#

[ -x "$(command -v dmenu)" ] || exit 1

# Environment setup

[ -n "$DTERM"     ] || export DTERM="dterm"
[ -n "$DHOME"     ] || export DHOME="${HOME}/.dterm/"
[ -n "$DCONFFILE" ] || export DCONFFILE="${HOME}/.dtermrc"
[ -n "$DHISTFILE" ] || export DHISTFILE="${DHOME}/history.dterm"
[ -n "$DHISTSIZE" ] || export DHISTSIZE="500"

[ -d "$DHOME"     ] || mkdir -p "$DHOME"
[ -f "$DCONFFILE" ] || touch "$DCONFFILE"
[ -f "$DHISTFILE" ] || touch "$DHISTFILE"


# Configuration

[ -n "$DSCROLL"   ] || DSCROLL="50"
[ -n "$DPROMPT"   ] || DPROMPT="$(echo "${PWD/$HOME/'~'}") \$"

# Main

# truncate history
tail -n "${DHISTSIZE}" "${DHISTFILE}.tmp" > "${DHISTFILE}"

# run dmenu and cmd into shell
awk '{a[i++]=$0} END {for (j=i-1; j>=0;) print a[j--] }' < "$DHISTFILE" | \

	# run history through dmenu
	dmenu -l "${DSCROLL}" -p "${DPROMPT}" $@ | \

	# put selection in the history file
	tee -a "${DHISTFILE}.tmp" | \

	# run selection through the shell
	"${SHELL:-"/bin/sh"}" &

