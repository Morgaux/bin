#!/bin/sh
# shellcheck disable=SC2068

#
# dmenu based browser searcher / launcher
#

set -e

dependencies surf dmenu

SELF="$(basename "$0")"
HISTFILE="${HOME}/.${SELF}.hist"

create_url() {
	case "$SELF" in 
		'dyt')     _BANG='!yt'    ;;
		'dreddit') _BANG='!r'     ;;
		'dstack')  _BANG='!stack' ;;
		'dgoogle') _BANG='!g'     ;;
		'dwiki')   _BANG='!w'     ;;
		'dscp')    _BANG='!scp'   ;;
		*)         _BANG='!?'     ;;
	esac

	echo "duckduckgo.com?q=${_BANG} ${SEARCH}" | sed 's/ /%20/g'
}

get_search() {
	_HISTORY="$(tail -n 20 "${HISTFILE}")"
	SEARCH="$(echo "$_HISTORY" | \
		awk '{a[i++]=$0} END {for (j=i-1; j>=0;) print a[j--]}' | \
		dmenu -p "${SELF}" -l 100 $@ | \
		tee -a "$HISTFILE")"
	if [ -z "$SEARCH" ]
	then
		echo "no selection" 1>&2
		exit 1
	fi
}

get_search $@

surf "$(create_url)" &

exit 0

