#!/bin/sh
# shellcheck disable=SC2068

#
# dmenu based browser searcher / launcher
#

SELF="$(basename "$0")"
HISTFILE="${HOME}/.${SELF}.hist"

err() {
	echo "${SELF}: $*" 1>&2
	return 1
}

die() {
	err "$@"
	exit 1
}

depends_on() {
	for dependancy in $@
	do
		if ! [ -x "$(command -v "$dependancy")" ]
		then
			die "$dependancy is not installed."
		fi
	done
}

create_url() {
	case "$SELF" in 
		'dyt')     _BANG='!yt'    ;;
		'dreddit') _BANG='!r'     ;;
		'dstack')  _BANG='!stack' ;;
		'dgoogle') _BANG='!g'     ;;
		'dwiki')   _BANG='!w'     ;;
		'dscp')    _BANG='!scp'   ;;
		*)         _BANG='!?'     ;;
	esac

	echo "duckduckgo.com?q=${_BANG} ${SEARCH}" | sed 's/ /%20/g'
}

get_search() {
	_HISTORY="$(tail -n 20 "${HISTFILE}")"
	SEARCH="$(echo "$_HISTORY" | \
		awk '{a[i++]=$0} END {for (j=i-1; j>=0;) print a[j--]}' | \
		dmenu -p "${SELF}" -l 100 $@ | \
		tee -a "$HISTFILE")"
	if [ -z "$SEARCH" ]
	then
		die "no selection"
	fi
}

main() {
	depends_on surf dmenu

	get_search $@

	surf "$(create_url)"
}

main $@

